<?xml version="1.0" encoding="utf-8"?>
<!-- This file is part of the SPFE Open Toolkit. See the accompanying license.txt file for applicable licenses.-->
<!-- (c) Copyright Analecta Communications Inc. 2012 All Rights Reserved. -->
<project name="spfe-rules" basedir="." default="draft">

	<xmlcatalog id="oasis-catalogs">
		<dtd publicId="-//OASIS//DTD XML Catalogs V1.1//EN"
			location="${SPFEOT_HOME}/1.0/schemas/catalog1.1.dtd"/>
	</xmlcatalog>
	<xmlcatalog id="spfe-catalogs">
		<classpath>
			<fileset dir="${SPFEOT_HOME}/tools/xml-commons-resolver-1.2">
				<include name="resolver.jar"/>
			</fileset>
			<fileset dir="${SPFEOT_HOME}/tools/config">
				<include name="CatalogManager.properties"/>
			</fileset>
		</classpath>
		<catalogpath>
			<fileset dir="${SPFEOT_HOME}/1.0/schemas">
				<include name="**/catalog.xml"/>
			</fileset>
			<fileset dir="${SPFEOT_HOME}/plugins">
				<include name="**/catalog.xml"/>
			</fileset>
			<fileset dir="${HOME}/.spfe" erroronmissingdir="no">
				<include name="**/catalog.xml"/>
			</fileset>
		</catalogpath>

	</xmlcatalog>

	<!-- MACRO DEFINITIONS -->
	<macrodef name="saxon-xslt">
		<attribute name="style"/>
		<attribute name="in"/>
		<attribute name="out"/>
		<attribute name="initial-template" default="main"/>
		<element name="params"/>
		<sequential>
			<xslt classpath="${SPFEOT_HOME}/tools/saxon9he/saxon9he.jar" style="@{style}" in="@{in}"
				out="@{out}">
				<xmlcatalog refid="spfe-catalogs"/>
				<params/>
				<factory name="net.sf.saxon.TransformerFactoryImpl">
					<attribute name="http://saxon.sf.net/feature/initialTemplate"
						value="@{initial-template}"/>
				</factory>
			</xslt>
		</sequential>
	</macrodef>

	<!-- PROPERTY DEFINITIONS -->

	<!-- properties for the temporary files used -->
	<property name="temp" value="${spfe.build.build-directory}"/>

	<property name="output" value="${spfe.build.output-directory}"/>

	<target name="-begin-message">
		<echo/>
		<echo/>
		<echo>=====================================================</echo>
		<echo>Beginning ${ant.project.invoked-targets} build of ${spfe.doc-set-id}</echo>
		<echo>====================================================</echo>
		<echo/>
		<echo/>
	</target>

	<!-- Initialization target -->
	<target name="-init" depends="-begin-message, -recorder"
		description="Initialization of properties." unless="already-initialized">

		<!-- avoid running -init twice so we don't run the last-build-crashed test twice -->
		<property name="already-initialized" value="true"/>

		<!-- check if the last build crashed -->
		<available property="last-build-crashed" file="${temp}/incomplete.flag"/>
		<antcall target="-check-last-build-status"/>

		<!-- mkdir in case no link catalogs have been created - make sure file list is created correctly even if empty. -->
		<mkdir dir="${spfe.build.link-catalog-directory}"/>
		<mkdir dir="${temp}"/>
	</target>

	<target name="-check-last-build-status" if="last-build-crashed">
		<echo/>
		<echo/>
		<echo>===========================================================================</echo>
		<echo>Last build failed and left a mess. Please run 'spfe -clean'. and try again.</echo>
		<echo>===========================================================================</echo>
		<echo/>
		<echo/>
		<fail/>
	</target>

	<!-- recorder target -->
	<target name="-recorder" if="spfe.topic-set-id">
		<echo message="Logging to: ${spfe.build.build-directory}/logs/${spfe.topic-set-id}.txt"/>
		<mkdir dir="${spfe.build.build-directory}/logs"/>
		<record name="${spfe.build.build-directory}/logs/${spfe.topic-set-id}-log.txt"
			action="start"/>
	</target>


	<!-- HTML -->

	<macrodef name="get.externals.graphics.html">
		<!--		depends="-build.image-list-html"
		if="image-list-html-has-content">
-->
		<attribute name="topic-set-id"/>
		<attribute name="output"/>
		<sequential>

			<local name="synthesis-files"/>
			<local name="synthesis-files-list"/>
			<fileset id="synthesis-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="synthesis/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="synthesis-files-list"
				refid="synthesis-files"/>
			<!-- build a list of images referenced in synthesis files -->
			<saxon-xslt in="${spfe.config-file}" style="${spfe.scripts.image-list}"
				out="${spfe.build.build-directory}/@{topic-set-id}/temp/image-list-html">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="synthesis-files" expression="${synthesis-files}"/>
					<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
				</params>
			</saxon-xslt>

			<files id="files.graphics.html"
				includesfile="${spfe.build.build-directory}/@{topic-set-id}/temp/image-list-html"/>

			<!--			<condition property="image-list-html-has-content">
				<isfileselected file="${spfe.build.build-directory}/@{topic-set-id}/temp/image-list-html">
					<containsregexp expression="\S+"/>
				</isfileselected>
			</condition>-->

			<mkdir dir="@{output}/graphics"/>
			<copy todir="@{output}/graphics" flatten="true" failonerror="false"
				preservelastmodified="true" verbose="true">
				<files refid="files.graphics.html"/>
			</copy>
		</sequential>
	</macrodef>

	<macrodef name="get.externals.style.html">
		<attribute name="output"/>
		<sequential>
			<mkdir dir="@{output}/style"/>
			<copy todir="@{output}/style" preservelastmodified="true" flatten="false"
				failonerror="true">
				<resources refid="spfe.style.html-style-directories"/>
			</copy>
		</sequential>
	</macrodef>

	
	<!-- PDF -->

	<target name="-get.externals.style.print">
		<mkdir dir="${temp}/graphics"/>
		<copy todir="${temp}/graphics" preservelastmodified="true" verbose="yes">
			<fileset dir="${spfe.directories.fo-template.graphics}" id="files.graphics.fo-template"
			/>
		</copy>
	</target>

	<target name="-get.externals.graphics.print" depends="-build.image-list.print"
		if="image-list-print-has-content">
		<mkdir dir="${temp}/graphics"/>
		<copy todir="${temp}/graphics" flatten="true" failonerror="true" preservelastmodified="true"
			verbose="true">
			<fileset refid="files.graphics.print"/>
		</copy>
	</target>

	<!-- =========== -->
	<!-- BUILD STEPS -->
	<!-- =========== -->
	<!-- provides properties and rules for performing the build steps -->

	<!-- define properties for the temporary files used -->
	<!--<property name="files.extracted-content" value="extracted-content.xml"/>-->

	<!-- GET TARGETS
	<macrodef name="-get.source-files.authored-content">
		<sequential>
			<copy todir="${temp}/authored-content" verbose="true" preservelastmodified="true"
				flatten="true">
				<files refid="authored-content-for-merge"/>
			</copy>
		</sequential>
	</macrodef> -->

	<!-- DEPENDENCY TARGETS -->
	<!-- check to see if extracted-content is up to date -->
	<!-- FIXME: Need to test that this is working correctly both ways.
	<target name="-current.extracted-content">
		<uptodate property="-current.functions-defs" targetfile="${temp}/${files.extracted-content}">
			<srcresources>
				<files refid="sources-to-extract-content-from"/>
			</srcresources>
		</uptodate>
	</target> -->

	<!-- EXTRACT TARGET -->
	<target name="-build.extracted-content" depends="--build.extracted-content"/>
	<macrodef name="build.extracted-content" description="extract content from source files">
		<attribute name="topic-set-id"/>
		<attribute name="style"/>
		<attribute name="sources-to-extract-content-from"/>
		<sequential>
			<saxon-xslt 
				style="@{style}" 
				in="${spfe.config-file}"
				out="${spfe.build.build-directory}/@{topic-set-id}/extracted.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="sources-to-extract-content-from"	expression="@{sources-to-extract-content-from}"/>
					<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
					<param name="draft" expression="${draft}" if="draft"/>
				</params>
			</saxon-xslt>

			<!--<!-\- validate the output file -\->
			<xmlvalidate lenient="yes" file="${temp}/${files.extracted-content}">
				<!-\- make the validation include namespaces -\->
				<attribute name="http://xml.org/sax/features/namespaces" value="true"/>
			</xmlvalidate>-->
		</sequential>
	</macrodef>


	<!-- SYNTHESIS STEP -->
	<target name="-build.synthesis" depends="-build.extracted-content, --build.synthesis"/>
	<!-- macro to build synthesis -->
	<macrodef name="build.synthesis" description="synthesis">
		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<attribute name="authored-content-files" default=""/>
		<sequential>
			<echo>Building synthesis for @{topic-set-id}.</echo>
			<!-- run the XSLT script to produce the output -->
			
			<local name="extracted-files"/>
			<local name="extracted-files-list"/>
			<fileset id="extracted-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="extracted/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="extracted-files-list"
				refid="extracted-files"/>
			
			<saxon-xslt 
				style="@{style}" 
				in="${spfe.config-file}"
				out="${spfe.build.build-directory}/@{topic-set-id}/synthesis.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="authored-content-files" expression="@{authored-content-files}"/>
					<param name="extracted-content-files" expression="${extracted-files-list}"/>
					<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
					<param name="draft" expression="${draft}" if="draft"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>


	<!-- LINK CATALOG STEP -->

	<!-- check if link-catalog is up to date 

	<target name="-current.link-catalog">
		<uptodate property="-current.link-catalog"
			targetfile="${spfe.build.link-catalog-directory}/${spfe.topic-set-id}.link-catalog"
			srcfile="${spfe.build.build-directory}/@{topic-set-id}/synthesis.flag"/>
	</target>-->

	<!-- target for link-catalog -->
	<target name="-build.link-catalog" depends="-build.synthesis, --build.link-catalog"/>
	<macrodef name="build.link-catalog" description="Link catalog step.">
		<!-- FIXME		depends="-current.link-catalog"
		unless="-current.link-catalog">-->
		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<sequential>
			<local name="synthesis-files"/>
			<local name="synthesis-files-list"/>
			<fileset id="synthesis-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="synthesis/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="synthesis-files-list"
				refid="synthesis-files"/>

			<!-- run the XSLT script to produce the output -->
			<saxon-xslt 
				in="${spfe.config-file}" 
				style="@{style}"
				out="${spfe.build.build-directory}/@{topic-set-id}/link-catalog.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="synthesis-files" expression="${synthesis-files-list}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>

	<!-- LIST PAGES STEP -->

	<!-- check if list page file is up to date -->

	<target name="-current.list-pages">
		<uptodate property="-current.list-pages"
			targetfile="${spfe.build.list-pages-directory}/${spfe.topic-set-id}.list-pages"
			srcfile="${spfe.build.build-directory}/@{topic-set-id}/synthesis.flag"/>
	</target>

	<!-- target for list-pages -->
	<!-- note that this target is called once at the doc set level -->

	<target name="-build.list-pages" depends="--build.list-pages"/>
	<macrodef name="build.list-pages" description="List page step.">
		<!--unless="-current.list-pages">-->
		<sequential>
			
			<!-- run the XSLT script to produce the output -->
			<saxon-xslt in="${spfe.config-file}" 
				style="${spfe.scripts.list-pages}"
				out="${spfe.build.list-pages-directory}/${spfe.topic-set-id}.list-pages.xml">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="synthesis-files" expression="${synthesis-files-list}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>

	<!-- target for toc -->
	<target name="-build.toc" depends=" -build.synthesis, --build.toc"/>
	<macrodef name="build.toc" description="TOC step.">
		<!-- FIXME		depends="  -current.link-catalog" unless="-current.link-catalog">-->
		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<sequential>
			<local name="synthesis-files"/>
			<local name="synthesis-files-list"/>
			<fileset id="synthesis-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="synthesis/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="synthesis-files-list"
				refid="synthesis-files"/>
			<local name="synthesis-files"/>
			<local name="synthesis-files-list"/>
			<fileset id="synthesis-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="synthesis/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="synthesis-files-list"
				refid="synthesis-files"/>

			<!-- run the XSLT script to produce the output -->
			<saxon-xslt 
				in="${spfe.config-file}" 
				style="@{style}"
				out="${spfe.build.build-directory}/@{topic-set-id}/toc.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="synthesis-files" expression="${synthesis-files-list}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>


	<!-- PRESENTATION WEB STEP -->


	<!-- check to see if the html-presentation is up to date -->
	<target name="-current.presentation-web">
		<uptodate property="-current.presentation-web"
			srcfile="${spfe.build.build-directory}/@{topic-set-id}/synthesis.flag"
			targetfile="${temp}/presentation/presentation-web.flag"/>
	</target>

	<!-- build the presentation -->
	<target name="-build.presentation-web"
		depends="-build.synthesis, -build.link-catalog,
				 -build.toc, --build.presentation-web"/>
	<macrodef name="build.presentation-web" description="presentation step.">
		<!--		depends="-current.presentation-web"
		unless="-current.presentation-web">-->
		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<sequential>
			<local name="synthesis-files"/>
			<local name="synthesis-files-list"/>
			<local name="toc-files"/>
			<local name="toc-files-list"/>
			<local name="link-catalog-files"/>
			<local name="link-catalog-list"/>
			<fileset id="synthesis-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="synthesis/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="synthesis-files-list"
				refid="synthesis-files"/>
			<fileset id="toc-files" dir="${spfe.build.toc-directory}">
				<include name="*.xml"/>
			</fileset>
			<pathconvert property="toc-files-list" dirsep="/" pathsep=";" refid="toc-files"/>
			<fileset id="link-catalog-files" dir="${spfe.build.link-catalog-directory}">
				<include name="*.xml"/>
			</fileset>			
			<pathconvert property="link-catalog-files-list" dirsep="/" pathsep=";" refid="link-catalog-files"/>
			<!-- run the XSLT script to produce the output -->
			<saxon-xslt style="@{style}" in="${spfe.config-file}"
				out="${spfe.build.build-directory}/@{topic-set-id}/temp/presentation-web.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="synthesis-files" expression="${synthesis-files-list}"/>
					<param name="link-catalog-files" expression="${link-catalog-files}"/>
					<param name="toc-files" expression="${toc-files-list}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>

	<!-- PRESENTATION BOOK STEP -->

	<!-- check to see if the presentation-book is up to date -->
	<target name="-current.presentation-book">
		<uptodate property="-current.presentation-book"
			srcfile="${spfe.build.build-directory}/@{topic-set-id}/synthesis.flag"
			targetfile="${temp}/presentation/presentation-book.flag"/>
	</target>

	<!-- build the book presentation -->
	<target name="-build.presentation-book" depends="-build.synthesis,--build.presentation-book"/>
	<macrodef name="--build.presentation-book" description="book presentation step.">
		<!--		depends="  -current.presentation-book" unless="-current.presentation-book">-->

		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<sequential>
			<local name="synthesis-files"/>
			<local name="synthesis-files-list"/>
			<fileset id="synthesis-files" dir="${spfe.build.build-directory}/@{topic-set-id}">
				<include name="synthesis/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="synthesis-files-list"
				refid="synthesis-files"/>
			<pathconvert property="toc-files" dirsep="/" pathsep=";" refid="tocs"/>
			<pathconvert property="link-catalog-files" dirsep="/" pathsep=";" refid="link-catalogs"/>
			<!-- run the XSLT script to produce the output -->
			<saxon-xslt in="${spfe.config-file}" style="${scripts.presentation-book}"
				out="${spfe.build.build-directory}/@{topic-set-id}/temp/presentation-book.flag">
				<params>
					<param name="topic-set-id" value="@{topic-set-id}"/>
					<param name="synthesis-files" expression="${synthesis-files}"/>
					<param name="link-catalog-files" expression="${link-catalog-files}"/>
					<param name="toc-files" expression="${toc-files}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>

	<!-- FORMAT HTML STEP -->

	<!-- check to see if the format is up to date -->
	<target name="-current.html-format">
		<uptodate property="-current.html-format" targetfile="${temp}/html-format.flag"
			srcfile="${temp}/presentation-web.flag"/>
	</target>

	<target name="-build.html-format" depends="-build.presentation-web, --build.html-format"/>
	<macrodef name="--build.html-format">
		<!--		depends="
	        	 -get.externals.style.html,
  				 -current.html-format"
		unless="-current.html-format">-->
		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<attribute name="output"/>
		<sequential>
			<property name="temp" value="${spfe.build.build-directory}/@{topic-set-id}/temp"/>
			<get.externals.graphics.html topic-set-id="@{topic-set-id}" output="@{output}"/>
			<get.externals.style.html output="@{output}"/>
			<fileset dir="${temp}" id="presentation-file-list">
				<include name="presentation/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="presentation-files"
				refid="presentation-file-list"/>
			<!-- run the XSLT script to produce the output -->
			<saxon-xslt in="${spfe.config-file}" style="${spfe.scripts.format-html}"
				out="${temp}/html-format.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
					<param name="presentation-files" expression="${presentation-files}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>




	<!-- FORMAT FO STEP -->
	<!-- FIXME: Need to make sure this is non-intersecting with the web presentation files -->

	<!-- check to see if the format is up to date -->
	<target name="-current.fo-format">
		<uptodate property="-current.fo-format" targetfile="${temp}/fo-format.flag"
			srcfile="${temp}/presentation-book.flag"/>
	</target>

	<target name="-build.fo-format" depends="-build.presentation-book, --build.fo-format"/>
	<macrodef name="build.fo-format" description="FO formatting">
		<!--depends=" -current.fo-format" unless="-current.fo-format"-->
		<attribute name="style"/>
		<attribute name="topic-set-id"/>
		<attribute name="output"/>
		<sequential>
			<property name="temp" value="${spfe.build.build-directory}/@{topic-set-id}/temp"/>
			<fileset id="presentation-file-list" dir="${temp}">
				<include name="presentation/*.xml"/>
			</fileset>
			<pathconvert dirsep="/" pathsep=";" property="presentation-files"
				refid="presentation-file-list"/>

			<pathconvert property="toc-files" dirsep="/" pathsep=";" refid="tocs"/>
			<!-- run the XSLT script to produce the output -->

			<saxon-xslt in="${spfe.config-file}" style="@{style}"
				out="${spfe.build.build-directory}/@{topic-set-id}/temp/fo-format.flag">
				<params>
					<param name="topic-set-id" expression="@{topic-set-id}"/>
					<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
					<param name="presentation-files" expression="${presentation-files}"/>
					<param name="toc-files" expression="${toc-files}"/>
				</params>
			</saxon-xslt>
		</sequential>
	</macrodef>


	<!-- ENCODE PDF STEP -->

	<!-- check to see if the format is up to date -->
	<target name="-current.pdf-encode">
		<uptodate property="-current.pdf-encode" targetfile="${output}/${spfe.pdf-name}"
			srcfile="{temp}/fo-format.flag"/>
	</target>

	<target name="-build.pdf-encode" depends=" -build.fo-format, --build.pdf-encode"/>
	<macrodef name="build.pdf-encode" description="PDF encoding">
		<!--		depends=" -get.externals.graphics.print, 
		-get.externals.style.print, 
		-current.pdf-encode"
		unless="-current.pdf-encode"-->
		<!-- run the XSLT script to produce the output -->
		<!-- make sure the output directory exists -->
		<attribute name="topic-set-id"/>
		<attribute name="output"/>
		<sequential>
			<property name="temp" value="${spfe.build.build-directory}/@{topic-set-id}/temp"/>
			<mkdir dir="@{output}"/>
			<fop format="application/pdf" fofile="${temp}/spfe.fo-format.fo"
				outfile="@{output}/${spfe.pdf-name}" basedir="${temp}"
				userconfig="${temp}/fop.xconf"/>
			<touch file="${temp}/pdf-format.flag"/>
		</sequential>
	</macrodef>


	<!-- REPORT STEP -->


	<!-- check to see if the html-presentation is up to date 
	<target name="-current.report">
		<uptodate property="-current.presentation-web" targetfile="${output}/${spfe.report-name}"
			srcfile="${spfe.build.build-directory}/@{topic-set-id}/synthesis.flag"/>
	</target>-->

	<!-- build the report 
	<target name="-build.report" description="report generation"
		depends="-build.synthesis, -current.report" unless="-current.report">

		<saxon-xslt in="${spfe.config-file}" style="${scripts.report}"
			out="${output}/${spfe.report-name}">
			<params>
			
				<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
				<param name="draft" expression="${draft}" if="draft"/>
			</params>
		</saxon-xslt>
	</target>-->


	<!-- IMAGE LIST STEP -->

	<!-- check to see if the image-list is up to date -->
	<target name="-current.image-list-html">
		<uptodate property="-current.image-list-html" targetfile="${temp}/image-list-html"
			srcfile="${temp}/presentation-web.flag"/>
	</target>

	<!-- check to see if the format is up to date -->
	<target name="-current.image-list.print">
		<uptodate property="-current.image-list.print" targetfile="${temp}/image-list-print"
			srcfile="{temp}/presentation-book.flag"/>
	</target>

	<target name="-build.image-list.print"
		depends="-build.presentation-book, -current.image-list.print"
		unless="-current.image-list.print">
		<saxon-xslt in="${spfe.config-file}" style="${spfe.scripts.image-list}"
			out="${temp}/image-list-print">
			<params>
				<param name="topic-set-id" expression="@{topic-set-id}"/>
				<param name="synthesis-files" expression="${synthesis-files}"/>
				<param name="terminate-on-error" expression="no" if="maintenance-mode"/>
				<param name="vector-if-available" expression="yes"/>
			</params>
		</saxon-xslt>
		<!--		<fileset id="files.graphics.print" dir="${spfe.directories.image-source}"
			includesfile="${temp}/image-list-print"/>-->
		<condition property="image-list-print-has-content">
			<isfileselected file="${temp}/image-list-print">
				<containsregexp expression="\S+"/>
			</isfileselected>
		</condition>
	</target>

	<!--===============-->
	<!-- USER COMMANDS -->
	<!--===============-->

	<!-- ZIP -->
	<target name="zip" depends="-init">
		<antcall target="-zip"/>
	</target>

	<!--	<target name="-zip" depends="-final, pdf">
		<mkdir dir="${spfe.directories.output.zip}"/>
		<basename property="zip-prefix" file=""/>
		<echo message="Zipping ${output}"/>
		<zip destfile="${spfe.directories.output.zip}/${spfe.zip-file-name}">
			<zipfileset dir="${output}" prefix="${zip-prefix}"/>
		</zip>
	</target>
-->

	<!-- DRAFT -->
	<target name="draft" depends="-init">
		<touch file="${temp}/incomplete.flag" mkdirs="true"/>
		<antcall target="-draft"/>
		<delete file="${temp}/incomplete.flag"/>
	</target>

	<target name="-draft" depends="-draft-flag, -final" description="Build the draft online output."/>

	<target name="-draft-flag">
		<!-- this is a separate rule to ensure it runs before -final -->
		<property name="draft" value="yes"/>
		<touch file="${temp}/draft.flag" mkdirs="true"/>
	</target>

	<!-- FINAL -->
	<target name="final" depends="-init, -final"/>
	<target name="-final" depends="-build.html-format" description="Build the final online output."/>

	<target name="-is-draft">
		<available property="is-draft" file="${temp}/draft.flag"/>
	</target>

	<!-- CLEAN -->
	<target name="clean" depends="-init, -clean"/>

	<target name="-clean" description="Clean build directory.">
		<retry retrycount="32" retrydelay="100">
			<delete dir="${spfe.docset-build-root-directory}/build" deleteonexit="true"
				performGCOnFailedDelete="true"/>
		</retry>
	</target>

	<!--	<!-\- WIP -\->
	<target name="wip" depends="-init, draft, pdf, -wip"/>
	<target name="-wip" description="Copy content to the work in progress website">
		<!-\- FIXME: Set failonerror to "no" to solve problems with non-SPFE things where there is nothing to copy. May be a better way to handle this. -\->
		<copy todir="${spfe.directories.internal-web}" preservelastmodified="true" failonerror="no">
			<fileset dir="${output}"/>
		</copy>
	</target>-->

	<!-- CAT -->
	<!-- Is all this antcall stuff needed, or will a simple dependency do? -->
	<target name="cat" depends="-init">
		<touch file="${temp}/incomplete.flag" mkdirs="true"/>
		<antcall target="-cat"/>
		<delete file="${temp}/incomplete.flag"/>
	</target>

	<target name="-cat" description="Build all the link catalogs">
		<antcall target="-build.link-catalog"/>
	</target>

	<!-- LIST -->
	<target name="list" depends="-init">
		<touch file="${temp}/incomplete.flag" mkdirs="true"/>
		<antcall target="-list"/>
		<delete file="${temp}/incomplete.flag"/>
	</target>

	<target name="-list" description="Build all the list pages">
		<antcall target="-build.list-pages"/>
	</target>

	<!-- TOC -->
	<target name="toc" depends="-init">
		<touch file="${temp}/incomplete.flag" mkdirs="true"/>
		<antcall target="-toc"/>
		<delete file="${temp}/incomplete.flag"/>
	</target>

	<target name="-toc" description="Build all tocs">
		<antcall target="-build.toc"/>
	</target>

	<!-- REPORT -->
	<target name="report" depends="-init">
		<touch file="${temp}/incomplete.flag" mkdirs="true"/>
		<antcall target="-report"/>
		<delete file="${temp}/incomplete.flag"/>
	</target>

	<target name="-report" description="Build all the report">
		<antcall target="-build.report"/>
	</target>

	<!-- PDF -->
	<target name="pdf" depends="-init, -pdf-skipped-message" description="Build the PDF output."
		if="spfe.pdf">
		<antcall target="-build.pdf-encode"/>
	</target>

	<target name="-pdf-skipped-message" unless="spfe.pdf">
		<echo message="PDF generation skipped because property spfe.pdf is not set."/>
	</target>

	<target name="test-mail">
		<property name="test-message"
			value="Congratulations ${spfe.mail.from}, you have successfully set up your environment to enable the SPFE build to send mail."/>
		<antcall target="-send-mail">
			<param name="spfe.mail.to" value="${spfe.mail.from}"/>
			<param name="mail.subject" value="Test message"/>
			<param name="mail.message" value="${test-message}"/>
		</antcall>
	</target>

	<target name="-send-mail">
		<mail mailhost="${spfe.mail.smtp.server}" mailport="${spfe.mail.smtp.port}"
			subject="${mail.subject}" encoding="plain">
			<from address="${spfe.mail.from}"/>
			<replyto address="${spfe.mail.from}"/>
			<to address="${spfe.mail.to}"/>
			<message>${mail.message}</message>
		</mail>
	</target>
</project>
